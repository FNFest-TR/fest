name: ğŸ› ï¸ Fix Unknown Users (Terminator)

on:
  workflow_dispatch: # Bu satÄ±r "Run Workflow" butonu ekler

jobs:
  repair-data:
    runs-on: ubuntu-latest
    permissions:
      contents: write # DosyalarÄ± dÃ¼zeltip kaydetmek iÃ§in izin

    steps:
    - name: Depoyu Ã‡ek (Checkout)
      uses: actions/checkout@v4

    - name: Python Kurulumu
      uses: actions/setup-python@v4
      with:
        python-version: '3.9'

    - name: KÃ¼tÃ¼phaneleri YÃ¼kle
      run: pip install requests

    - name: Ä°natÃ§Ä± Tamir Scriptini OluÅŸtur ve Ã‡alÄ±ÅŸtÄ±r
      env:
        EPIC_REFRESH_TOKEN: ${{ secrets.EPIC_REFRESH_TOKEN }}
        # Client ID/Secret halka aÃ§Ä±k olduÄŸu iÃ§in buraya gÃ¶mdÃ¼k (Hata riskini sÄ±fÄ±rladÄ±k)
        EPIC_CLIENT_ID: "ec684b8c687f479fadea3cb2ad83f5c6"
        EPIC_CLIENT_SECRET: "e1f31c211f28413186262d37a13fc84d"
      run: |
        # Python kodunu direkt buraya yazÄ±yoruz, dosya yÃ¼klemene gerek yok
        cat <<EOF > auto_repair.py
        import os, json, requests, time, base64

        KLASOR_YOLU = "leaderboards/season12"
        MY_REFRESH_TOKEN = os.environ["EPIC_REFRESH_TOKEN"]
        CLIENT_ID = os.environ["EPIC_CLIENT_ID"]
        CLIENT_SECRET = os.environ["EPIC_CLIENT_SECRET"]

        def get_token():
            if not MY_REFRESH_TOKEN: return None
            auth = base64.b64encode(f"{CLIENT_ID}:{CLIENT_SECRET}".encode()).decode()
            try:
                r = requests.post("https://account-public-service-prod.ol.epicgames.com/account/api/oauth/token",
                                headers={"Authorization": f"Basic {auth}", "Content-Type": "application/x-www-form-urlencoded"},
                                data={"grant_type": "refresh_token", "refresh_token": MY_REFRESH_TOKEN})
                return r.json().get("access_token")
            except: return None

        def get_names_robust(ids, token):
            id_map = {}
            # 20'ÅŸerli gruplar halinde sor (Daha gÃ¼venli)
            for i in range(0, len(ids), 20):
                chunk = [x for x in ids[i:i+20] if x and isinstance(x, str)]
                if not chunk: continue
                
                url = f"https://account-public-service-prod.ol.epicgames.com/account/api/public/account?accountId={'&accountId='.join(chunk)}"
                
                # 3 Kere Dene (Retry Logic)
                for attempt in range(3):
                    try:
                        r = requests.get(url, headers={"Authorization": f"Bearer {token}"}, timeout=10)
                        if r.status_code == 200:
                            for u in r.json(): id_map[u["id"]] = u.get("displayName", "Unknown")
                            break # BaÅŸarÄ±lÄ±
                        elif r.status_code == 429: time.sleep(5 + (attempt*2)) # Rate limit beklemesi
                        else: time.sleep(1)
                    except: time.sleep(1)
                time.sleep(0.5)
            return id_map

        def main():
            token = get_token()
            if not token: print("Token alÄ±namadÄ±!"); return
            
            print(f"ğŸš€ BaÅŸlÄ±yor: {KLASOR_YOLU}")
            duzelen = 0
            
            for root, dirs, files in os.walk(KLASOR_YOLU):
                for file in files:
                    if not file.endswith(".json"): continue
                    path = os.path.join(root, file)
                    
                    try:
                        with open(path, "r", encoding="utf-8") as f: data = json.load(f)
                        entries = data if isinstance(data, list) else data.get("entries", [])
                        
                        # Unknown ve geÃ§erli ID'si olanlarÄ± bul
                        targets = [e["account_id"] for e in entries if e.get("userName") == "Unknown" and e.get("account_id") and isinstance(e.get("account_id"), str)]
                        
                        if targets:
                            print(f"ğŸ”§ {file}: {len(targets)} kiÅŸi soruluyor...")
                            names = get_names_robust(targets, token)
                            changed = False
                            for e in entries:
                                if e.get("userName") == "Unknown" and e.get("account_id") in names:
                                    e["userName"] = names[e["account_id"]]
                                    changed = True
                            
                            if changed:
                                save_data = entries if isinstance(data, list) else {"entries": entries}
                                with open(path, "w", encoding="utf-8") as f: json.dump(save_data, f, indent=4)
                                duzelen += 1
                                print(f"âœ… {file} DÃ¼zeldi!")
                    except Exception as e: print(f"Hata {file}: {e}")
            
            print(f"ğŸ Bitti. Toplam {duzelen} dosya gÃ¼ncellendi.")

        if __name__ == "__main__": main()
        EOF

        # OluÅŸturulan scripti Ã§alÄ±ÅŸtÄ±r
        python auto_repair.py

    - name: DeÄŸiÅŸiklikleri Kaydet (Commit & Push)
      run: |
        git config --global user.name "Fix Bot"
        git config --global user.email "bot@github.com"
        
        if [[ `git status --porcelain` ]]; then
          git add leaderboards/
          git commit -m "ğŸ©¹ Unknown kullanÄ±cÄ±lar onarÄ±ldÄ± (Auto-Fix)"
          git push
          echo "âœ… GitHub deposu gÃ¼ncellendi."
        else
          echo "âœ¨ Zaten her ÅŸey dÃ¼zgÃ¼n, deÄŸiÅŸiklik yok."
        fi
