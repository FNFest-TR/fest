name: Skor Çekme İşlemi

on:
  workflow_dispatch:
  schedule:
    - cron: '0 0 * * *'

jobs:
  # 1. AŞAMA: HER ENSTRÜMANI TEK TEK ÇEK (SCRAPE)
  scrape:
    runs-on: ubuntu-latest
    strategy:
      # ÖNEMLİ: İşleri aynı anda değil, sırayla yapar (Rate Limit yememek için)
      max-parallel: 1
      matrix:
        instrument:
          - 'Solo_Guitar'
          - 'Solo_Drums'
          - 'Solo_Bass'
          - 'Solo_Vocals'
          - 'Solo_PeripheralGuitar'
          - 'Solo_PeripheralBass'
      fail-fast: false

    steps:
      # OPTİMİZASYON: "Checkout" adımını hızlandırmak için sadece "actions.py" dosyasını indiriyoruz.
      # Binlerce JSON dosyasını indirmediği için işlem saniyeler sürer ve donmaz.
      - name: Checkout repository (Sparse)
        uses: actions/checkout@v4
        with:
          sparse-checkout: |
            actions.py
          sparse-checkout-cone-mode: false

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'

      - name: Install dependencies
        run: pip install requests

      # Temiz bir çıktı klasörü oluştur
      - name: Create output directory
        run: mkdir ./output

      # Python scriptini çalıştır
      - name: Run Scraper for ${{ matrix.instrument }}
        env:
          EPIC_REFRESH_TOKEN: ${{ secrets.EPIC_REFRESH_TOKEN }}
          EPIC_BASIC_AUTH: ${{ secrets.EPIC_BASIC_AUTH }}
        run: python actions.py ${{ matrix.instrument }} ./output

      # Oluşan dosyaları geçici olarak yükle
      - name: Upload leaderboards artifact
        uses: actions/upload-artifact@v4
        with:
          name: leaderboards-${{ matrix.instrument }}
          path: ./output/leaderboards/

  # 2. AŞAMA: TÜM DOSYALARI BİRLEŞTİR VE ÜZERİNE YAZ (COMMIT)
  commit-files:
    needs: scrape
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      # Burada tüm repoyu indiriyoruz çünkü değişiklikleri işleyip commit atacağız
      - name: Checkout repository (Full)
        uses: actions/checkout@v4

      # Önceki aşamada üretilen tüm taze dosyaları indir.
      # Mevcut "leaderboards" klasörünün içine, eski dosyaların ÜZERİNE yazar.
      - name: Download all leaderboards artifacts
        uses: actions/download-artifact@v4
        with:
          pattern: leaderboards-*
          merge-multiple: true
          path: leaderboards/

      # Değişiklikleri Git'e kaydet ve gönder
      - name: Commit and push if changed
        uses: stefanzweifel/git-auto-commit-action@v5
        with:
          commit_message: "Data: Leaderboard update (Overwrite)"
          file_pattern: leaderboards
